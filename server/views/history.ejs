<%- include('partials/header', { pageTitle: '過去のニュースレポート' }) %>

<h2>📚 過去のニュースレポート一覧</h2>

<!-- 即時絞り込み用検索 -->
<input type="text" id="searchInput" placeholder="ニュース本文で検索" 
       style="width:100%; max-width:400px; padding:0.5rem; margin-bottom:0.5rem; border-radius:5px; border:1px solid #ccc; background:#fff; color:#000;">

<ul id="reportList" style="background:var(--card-bg); padding:1.5rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
  <% reports.forEach(report => { %>
    <li><a href="/public/history/<%= report.filename %>" target="_blank">
      <%= report.displayName %>
    </a></li>
  <% }) %>
</ul>

<p><a href="/">← 最新レポートに戻る</a></p>

<script>
  const searchInput = document.getElementById('searchInput');
  const reportList  = document.getElementById('reportList');

  // 初期（全履歴）のHTML：空に戻す時に使う
  const initialListHTML = `\
<% reports.forEach(report => { %>
  <li><a href="/public/history/<%= report.filename %>" target="_blank"><%= report.displayName %></a></li>
<% }) %>`;

  // 簡易エスケープ
  const esc = (s) => String(s).replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  searchInput.addEventListener('keyup', async function () {
    const query = this.value.trim();

    // 入力なし → 初期表示へ
    if (!query) {
      reportList.innerHTML = initialListHTML;
      return;
    }

    // /search は「日付ごとに items（見出し配列）」を返す版を想定
    const res    = await fetch(`/search?q=${encodeURIComponent(query)}`);
    const groups = await res.json();

    // 総ヒット件数（見出し件数）
    const total = groups.reduce((sum, g) => sum + ((g.items && g.items.length) || 0), 0);

    // 0件表示
    if (total === 0) {
      reportList.innerHTML = `
        <li class="list-none">
          <div class="mt-3 p-4 rounded-md shadow"
               style="background:var(--card-bg); color:var(--text-color); border-left:4px solid #f59e0b;">
            該当するニュースが見つかりません。
            <div style="opacity:.8; font-size:.9rem; margin-top:.25rem;">
              ヒント：キーワードを短くする／別表記で試す（例：<span style="opacity:.9">花火大会</span> → <span style="opacity:.9">花火</span>）
            </div>
          </div>
        </li>`;
      return;
    }

    // レポート → 見出し（外部記事URL）を入れ子で表示
    reportList.innerHTML = groups.slice(0, 10).map(g => `
      <li class="mb-3">
        <a href="/public/history/${g.filename}" target="_blank" class="font-semibold underline">
          ${esc(g.displayName)}
        </a>
        <ul class="mt-1 ml-5 list-disc">
          ${(g.items || []).slice(0, 8).map(it =>
            `<li><a href="${esc(it.url)}" target="_blank" rel="noopener noreferrer">${esc(it.title)}</a></li>`
          ).join('')}
        </ul>
      </li>
    `).join('');
  });
</script>

<%- include('partials/footer') %>
