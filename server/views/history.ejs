<%- include('partials/header', { pageTitle: 'éå»ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ' }) %>

<h2>ğŸ“š éå»ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§</h2>

<!-- å³æ™‚çµã‚Šè¾¼ã¿ç”¨æ¤œç´¢ -->
<input type="text" id="searchInput" placeholder="ãƒ‹ãƒ¥ãƒ¼ã‚¹æœ¬æ–‡ã§æ¤œç´¢" 
       style="width:100%; max-width:400px; padding:0.5rem; margin-bottom:0.5rem; border-radius:5px; border:1px solid #ccc; background:#fff; color:#000;">

<ul id="reportList" style="background:var(--card-bg); padding:1.5rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
  <% reports.forEach(report => { %>
    <li><a href="/public/history/<%= report.filename %>" target="_blank">
      <%= report.displayName %>
    </a></li>
  <% }) %>
</ul>

<p><a href="/">â† æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆã«æˆ»ã‚‹</a></p>

<script>
  const searchInput = document.getElementById('searchInput');
  const reportList  = document.getElementById('reportList');

  // åˆæœŸï¼ˆå…¨å±¥æ­´ï¼‰ã®HTMLï¼šç©ºã«æˆ»ã™æ™‚ã«ä½¿ã†
  const initialListHTML = `\
<% reports.forEach(report => { %>
  <li><a href="/public/history/<%= report.filename %>" target="_blank"><%= report.displayName %></a></li>
<% }) %>`;

  // ç°¡æ˜“ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  const esc = (s) => String(s).replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );

  searchInput.addEventListener('keyup', async function () {
    const query = this.value.trim();

    // å…¥åŠ›ãªã— â†’ åˆæœŸè¡¨ç¤ºã¸
    if (!query) {
      reportList.innerHTML = initialListHTML;
      return;
    }

    // /search ã¯ã€Œæ—¥ä»˜ã”ã¨ã« itemsï¼ˆè¦‹å‡ºã—é…åˆ—ï¼‰ã€ã‚’è¿”ã™ç‰ˆã‚’æƒ³å®š
    const res    = await fetch(`/search?q=${encodeURIComponent(query)}`);
    const groups = await res.json();

    // ç·ãƒ’ãƒƒãƒˆä»¶æ•°ï¼ˆè¦‹å‡ºã—ä»¶æ•°ï¼‰
    const total = groups.reduce((sum, g) => sum + ((g.items && g.items.length) || 0), 0);

    // 0ä»¶è¡¨ç¤º
    if (total === 0) {
      reportList.innerHTML = `
        <li class="list-none">
          <div class="mt-3 p-4 rounded-md shadow"
               style="background:var(--card-bg); color:var(--text-color); border-left:4px solid #f59e0b;">
            è©²å½“ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚
            <div style="opacity:.8; font-size:.9rem; margin-top:.25rem;">
              ãƒ’ãƒ³ãƒˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ­ãã™ã‚‹ï¼åˆ¥è¡¨è¨˜ã§è©¦ã™ï¼ˆä¾‹ï¼š<span style="opacity:.9">èŠ±ç«å¤§ä¼š</span> â†’ <span style="opacity:.9">èŠ±ç«</span>ï¼‰
            </div>
          </div>
        </li>`;
      return;
    }

    // ãƒ¬ãƒãƒ¼ãƒˆ â†’ è¦‹å‡ºã—ï¼ˆå¤–éƒ¨è¨˜äº‹URLï¼‰ã‚’å…¥ã‚Œå­ã§è¡¨ç¤º
    reportList.innerHTML = groups.slice(0, 10).map(g => `
      <li class="mb-3">
        <a href="/public/history/${g.filename}" target="_blank" class="font-semibold underline">
          ${esc(g.displayName)}
        </a>
        <ul class="mt-1 ml-5 list-disc">
          ${(g.items || []).slice(0, 8).map(it =>
            `<li><a href="${esc(it.url)}" target="_blank" rel="noopener noreferrer">${esc(it.title)}</a></li>`
          ).join('')}
        </ul>
      </li>
    `).join('');
  });
</script>

<%- include('partials/footer') %>
